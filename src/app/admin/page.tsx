/**
 * @file src/app/admin/page.tsx
 * @description
 * ê´€ë¦¬ì í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸
 *
 * ì£¼ìš” ê¸°ëŠ¥:
 * 1. ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ì œì–´ (ì‹œì‘/ì •ì§€)
 * 2. DBì™€ PLC ìš´ì˜ ëª¨ë“œ í‘œì‹œ (â­ NEW: Mock/Real ëª¨ë“œ í‘œì‹œ)
 * 3. ë¶ˆëŸ‰ ê·œì¹™ ê´€ë¦¬ (ì¡°íšŒ/ì¶”ê°€/ì‚­ì œ)
 * 4. ê·œì¹™ í…Œì´ë¸” í‘œì‹œ
 * 5. ê·œì¹™ ì¶”ê°€ ëª¨ë‹¬
 *
 * ê·œì¹™ ê´€ë¦¬:
 * - ë¶ˆëŸ‰ ì½”ë“œ, ì´ë¦„, ì„ê³„ê°’ ì„¤ì •
 * - ì„ê³„ê°’ 1 = ì¦‰ì‹œ ì •ì§€
 * - ì„ê³„ê°’ N = 1ì‹œê°„ ë‚´ NíšŒ ë°œìƒ ì‹œ ì •ì§€
 *
 * ì„œë¹„ìŠ¤ ì œì–´:
 * - Start: ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ì‹œì‘
 * - Stop: ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ì •ì§€
 * - ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ (ì´ˆë¡/ë¹¨ê°• ì )
 * - DB í´ë§ ëª¨ë“œ: ğŸ”§ Mock ë˜ëŠ” ğŸ”Œ Real
 * - PLC ì—°ê²° ëª¨ë“œ: ğŸ”§ Mock ë˜ëŠ” ğŸ”Œ Real
 *
 * ì‚¬ìš©ë²•:
 * 1. "Add Rule" ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ê·œì¹™ ì¶”ê°€
 * 2. í…Œì´ë¸”ì—ì„œ ê·œì¹™ í™•ì¸ ë° ì‚­ì œ
 * 3. Start/Stop ë²„íŠ¼ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì œì–´
 * 4. ìš´ì˜ ëª¨ë“œ ì •ë³´ì—ì„œ í˜„ì¬ Mock/Real ëª¨ë“œ í™•ì¸
 */

"use client";

import { useEffect, useState } from "react";
import axios from "axios";
import { Play, Square, Plus, Trash2, Shield, Edit } from "lucide-react";
import { cn } from "@/lib/utils";
// import ProtectedRoute from "@/components/ProtectedRoute"; // Login feature removed

interface DefectRule {
  code: string;
  name: string;
  threshold: number;
  is_active: boolean;
}

export default function AdminPage() {
  const [isRunning, setIsRunning] = useState(false);
  const [plcStatus, setPlcStatus] = useState<"RUNNING" | "STOPPED">("RUNNING");
  const [plcStopReason, setPlcStopReason] = useState<string>("");
  const [dbMode, setDbMode] = useState<"Mock" | "Real">("Mock"); // â­ NEW: DB í´ë§ ëª¨ë“œ
  const [plcMode, setPlcMode] = useState<"Mock" | "Real">("Mock"); // â­ NEW: PLC ì—°ê²° ëª¨ë“œ
  const [rules, setRules] = useState<DefectRule[]>([]);
  const [isLoadingRules, setIsLoadingRules] = useState(true); // â­ ê·œì¹™ ë¡œë”© ìƒíƒœ
  const [isTogglingService, setIsTogglingService] = useState(false); // â­ NEW: ì„œë¹„ìŠ¤ í† ê¸€ ë¡œë”© ìƒíƒœ
  const [newRule, setNewRule] = useState({ code: "", name: "", threshold: 5 });
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingCode, setEditingCode] = useState<string | null>(null);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [editRule, setEditRule] = useState({
    code: "",
    name: "",
    threshold: 5,
  });
  const [toast, setToast] = useState<{
    isOpen: boolean;
    message: string;
    type: "success" | "error";
  }>({
    isOpen: false,
    message: "",
    type: "success",
  });
  const [dialog, setDialog] = useState<{
    isOpen: boolean;
    type: "alert" | "confirm";
    title: string;
    message: string;
    onConfirm?: () => void;
  }>({
    isOpen: false,
    type: "alert",
    title: "",
    message: "",
  });

  /**
   * ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ìƒíƒœ ë° ê·œì¹™ ì¡°íšŒ (ë³‘ë ¬ ì²˜ë¦¬)
   */
  useEffect(() => {
    // â­ ë³‘ë ¬ë¡œ ìš”ì²­í•´ì„œ ì´ˆê¸° ë¡œë“œ ì‹œê°„ ë‹¨ì¶•
    Promise.all([fetchStatus(), fetchRules()]);
  }, []);

  /**
   * ì„œë¹„ìŠ¤ ì‹¤í–‰ ìƒíƒœ ì¡°íšŒ
   * â­ DBì™€ PLC ëª¨ë“œ ì •ë³´ë„ í•¨ê»˜ ì¡°íšŒ
   */
  const fetchStatus = async () => {
    try {
      const res = await axios.get("/api/status");
      // system_status.db_polling ê°’ì„ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ ìƒíƒœ íŒë‹¨
      // last_polling_timeì€ ì„œë¹„ìŠ¤ê°€ ì •ì§€ë˜ì–´ë„ ê°’ì´ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìƒíƒœ íŒë‹¨ìš©ìœ¼ë¡œëŠ” ë¶€ì ì ˆí•¨
      const isActuallyRunning = res.data.system_status?.db_polling ?? false;
      setIsRunning(isActuallyRunning);
      setPlcStatus(res.data.line_status || "RUNNING");
      setPlcStopReason(res.data.stop_reason || "");
      // â­ NEW: DBì™€ PLC ëª¨ë“œ ì •ë³´ ì„¤ì •
      setDbMode(res.data.system_status?.db_mode || "Mock");
      setPlcMode(res.data.system_status?.plc_mode || "Mock");
    } catch (e) {
      console.error(e);
    }
  };

  /**
   * ëª¨ë“  ê·œì¹™ ì¡°íšŒ
   * â­ ë¡œë”© ìƒíƒœ ì¶”ì  (ê·œì¹™ ì¡°íšŒ ì™„ë£Œ í›„ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”)
   */
  const fetchRules = async () => {
    try {
      setIsLoadingRules(true); // â­ ë¡œë”© ì‹œì‘
      const res = await axios.get("/api/admin/rules");
      setRules(res.data);
    } catch (e) {
      console.error(e);
    } finally {
      setIsLoadingRules(false); // â­ ë¡œë”© ì™„ë£Œ (ì„±ê³µ/ì‹¤íŒ¨ ìƒê´€ì—†ì´)
    }
  };

  /**
   * í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í—¬í¼ í•¨ìˆ˜
   */
  const showToast = (
    message: string,
    type: "success" | "error" = "success"
  ) => {
    setToast({
      isOpen: true,
      message,
      type,
    });
    // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«ê¸°
    setTimeout(() => {
      setToast((prev) => ({ ...prev, isOpen: false }));
    }, 3000);
  };

  /**
   * ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ í—¬í¼ í•¨ìˆ˜
   */
  const showAlert = (title: string, message: string) => {
    setDialog({
      isOpen: true,
      type: "alert",
      title,
      message,
    });
  };

  const showConfirm = (
    title: string,
    message: string,
    onConfirm: () => void
  ) => {
    setDialog({
      isOpen: true,
      type: "confirm",
      title,
      message,
      onConfirm,
    });
  };

  const closeDialog = () => {
    setDialog({
      isOpen: false,
      type: "alert",
      title: "",
      message: "",
    });
  };

  /**
   * ì„œë¹„ìŠ¤ ì‹œì‘/ì •ì§€
   * â­ fetchStatus()ë¥¼ awaitë¡œ ê¸°ë‹¤ë ¤ì„œ UI ìƒíƒœê°€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë˜ë„ë¡ í•¨
   * â­ NEW: ë¡œë”© ìƒíƒœ ì¶”ê°€ë¡œ ì¤‘ë³µ í´ë¦­ ë°©ì§€
   */
  const toggleService = async (action: "start" | "stop") => {
    // ë¡œë”© ì¤‘ì´ê±°ë‚˜ ê·œì¹™ ë¡œë”© ì¤‘ì´ë©´ ì‹¤í–‰ ì•ˆ í•¨
    if (isTogglingService || isLoadingRules) {
      return;
    }

    setIsTogglingService(true);
    try {
      await axios.post("/api/admin/control", { action });
      // â­ fetchStatus()ë¥¼ awaitë¡œ ê¸°ë‹¤ë¦¬ê¸° (ì¦‰ì‹œ ìƒíƒœ ë™ê¸°í™”)
      await fetchStatus();
      const message =
        action === "start"
          ? "ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤"
          : "ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ê°€ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤";
      showToast(message, "success");
    } catch (e) {
      showToast("ì„œë¹„ìŠ¤ ì œì–´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤", "error");
    } finally {
      setIsTogglingService(false);
    }
  };

  /**
   * PLC ê°•ì œ ì œì–´
   */
  const togglePlc = (action: "force_stop" | "force_reset") => {
    const actionName = action === "force_stop" ? "ê°•ì œ ì •ì§€" : "ê°•ì œ í•´ì œ";

    showConfirm(
      "PLC ì œì–´ í™•ì¸",
      `ì •ë§ë¡œ PLCë¥¼ ${actionName} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      async () => {
        closeDialog(); // â­ ë‹¤ì´ì–¼ë¡œê·¸ ë¨¼ì € ë‹«ê¸° (UX ê°œì„ )
        try {
          await axios.post("/api/admin/control", { action });
          await fetchStatus();
          showToast(`PLC ${actionName} ëª…ë ¹ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤`, "success");
        } catch (e) {
          showToast(`PLC ${actionName} ì‹¤íŒ¨`, "error");
        }
      }
    );
  };

  /**
   * ìƒˆ ê·œì¹™ ì¶”ê°€
   */
  const handleAddRule = async () => {
    // ì…ë ¥ê°’ ê²€ì¦
    if (!newRule.code.trim()) {
      showAlert("ì…ë ¥ ì˜¤ë¥˜", "ë¶ˆëŸ‰ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }
    if (!newRule.name.trim()) {
      showAlert("ì…ë ¥ ì˜¤ë¥˜", "ë¶ˆëŸ‰ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }
    if (newRule.threshold < 1) {
      showAlert("ì…ë ¥ ì˜¤ë¥˜", "ì„ê³„ê°’ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤");
      return;
    }

    try {
      console.log("[Admin] ê·œì¹™ ì¶”ê°€ ì‹œë„:", newRule);
      const response = await axios.post("/api/admin/rules", {
        ...newRule,
        is_active: true,
        created_at: "",
      });
      console.log("[Admin] ê·œì¹™ ì¶”ê°€ ì„±ê³µ:", response.data);

      setIsModalOpen(false);
      setNewRule({ code: "", name: "", threshold: 5 });
      fetchRules();
      showAlert("ì„±ê³µ", "ê·œì¹™ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤");
    } catch (e: any) {
      console.error("[Admin] ê·œì¹™ ì¶”ê°€ ì‹¤íŒ¨:", e);
      showAlert("ì˜¤ë¥˜", e.response?.data?.error || "ê·œì¹™ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    }
  };

  /**
   * ê·œì¹™ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
   */
  const handleEditRule = (rule: DefectRule) => {
    setEditRule({
      code: rule.code,
      name: rule.name,
      threshold: rule.threshold,
    });
    setEditingCode(rule.code);
    setIsEditModalOpen(true);
  };

  /**
   * ê·œì¹™ ìˆ˜ì • ì €ì¥
   */
  const handleSaveEdit = async () => {
    // ì…ë ¥ê°’ ê²€ì¦
    if (!editRule.name.trim()) {
      showAlert("ì…ë ¥ ì˜¤ë¥˜", "ë¶ˆëŸ‰ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }
    if (editRule.threshold < 1) {
      showAlert("ì…ë ¥ ì˜¤ë¥˜", "ì„ê³„ê°’ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤");
      return;
    }

    try {
      console.log("[Admin] ê·œì¹™ ìˆ˜ì • ì‹œë„:", editRule);
      await axios.put(`/api/admin/rules/${editingCode}`, {
        name: editRule.name,
        threshold: editRule.threshold,
      });
      console.log("[Admin] ê·œì¹™ ìˆ˜ì • ì„±ê³µ");

      setIsEditModalOpen(false);
      setEditingCode(null);
      fetchRules();
      showAlert("ì„±ê³µ", "ê·œì¹™ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤");
    } catch (e: any) {
      console.error("[Admin] ê·œì¹™ ìˆ˜ì • ì‹¤íŒ¨:", e);
      showAlert("ì˜¤ë¥˜", e.response?.data?.error || "ê·œì¹™ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    }
  };

  /**
   * ê·œì¹™ ì‚­ì œ
   */
  const handleDeleteRule = (code: string) => {
    showConfirm(
      "ê·œì¹™ ì‚­ì œ",
      `ê·œì¹™ ${code}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
      async () => {
        try {
          await axios.delete(`/api/admin/rules/${code}`);
          fetchRules();
          closeDialog();
        } catch (e) {
          closeDialog();
          showAlert("ì˜¤ë¥˜", "ê·œì¹™ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
        }
      }
    );
  };

  return (
    <div className="min-h-screen p-8 max-w-7xl mx-auto">
      {/* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */}
      {toast.isOpen && (
        <div
          className="fixed top-4 right-4 z-50 flex items-center gap-3 px-6 py-4 rounded-lg shadow-lg animate-in fade-in slide-in-from-top-2 duration-300"
          style={{
            backgroundColor: toast.type === "success" ? "#10b981" : "#ef4444",
            color: "white",
          }}
        >
          <div>{toast.type === "success" ? "âœ“" : "âœ•"}</div>
          <span className="font-semibold">{toast.message}</span>
        </div>
      )}

      <header className="mb-8 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <div className="p-3 bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-xl border border-blue-500/30">
            <Shield className="w-8 h-8 text-blue-400" />
          </div>
          <div>
            <h1 className="text-3xl font-bold">ì‹œìŠ¤í…œ ê´€ë¦¬</h1>
          </div>
        </div>
      </header>

      {/* ì„œë¹„ìŠ¤ ì œì–´ ì„¹ì…˜ */}
      <section className="mb-12 bg-card border rounded-xl p-6 shadow-sm">
        <h2 className="text-xl font-semibold mb-6">ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ì œì–´</h2>

        {/* ì„œë¹„ìŠ¤ ìƒíƒœ í–‰ */}
        <div className="flex items-center gap-6 mb-6 pb-6 border-b border-border/50">
          {/* ìƒíƒœ í‘œì‹œ */}
          <div
            className={cn(
              "w-4 h-4 rounded-full animate-pulse",
              isRunning ? "bg-green-500" : "bg-red-500"
            )}
          />
          <span className="text-lg font-medium">
            {isRunning ? "ì„œë¹„ìŠ¤ ì‹¤í–‰ ì¤‘" : "ì„œë¹„ìŠ¤ ì •ì§€ë¨"}
          </span>

          {/* ì œì–´ ë²„íŠ¼ */}
          <div className="flex gap-2 ml-auto">
            <button
              onClick={() => toggleService("start")}
              disabled={isRunning || isLoadingRules || isTogglingService} // â­ NEW: ë¡œë”© ì¤‘ì´ë©´ ë¹„í™œì„±í™”
              className="flex items-center gap-2 px-6 py-2 bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 rounded-lg hover:bg-emerald-500/20 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isTogglingService ? (
                <>
                  <div className="w-4 h-4 border-2 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin" />
                  ì²˜ë¦¬ ì¤‘...
                </>
              ) : isLoadingRules ? (
                <>
                  <div className="w-4 h-4 border-2 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin" />
                  ë¡œë”© ì¤‘...
                </>
              ) : (
                <>
                  <Play className="w-4 h-4" /> ì‹œì‘
                </>
              )}
            </button>
            <button
              onClick={() => toggleService("stop")}
              disabled={!isRunning || isTogglingService} // â­ NEW: ë¡œë”© ì¤‘ì´ë©´ ë¹„í™œì„±í™”
              className="flex items-center gap-2 px-6 py-2 bg-red-500/10 text-red-500 border border-red-500/20 rounded-lg hover:bg-red-500/20 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isTogglingService ? (
                <>
                  <div className="w-4 h-4 border-2 border-red-500/30 border-t-red-500 rounded-full animate-spin" />
                  ì²˜ë¦¬ ì¤‘...
                </>
              ) : (
                <>
                  <Square className="w-4 h-4 fill-current" /> ì •ì§€
                </>
              )}
            </button>
          </div>
        </div>

        {/* â­ NEW: ìš´ì˜ ëª¨ë“œ ì •ë³´ í–‰ */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="flex items-center gap-2">
            <span className="text-sm text-muted-foreground">DB í´ë§ ëª¨ë“œ:</span>
            <span
              className={cn(
                "px-3 py-1 rounded-full text-xs font-bold",
                dbMode === "Mock"
                  ? "bg-blue-500/20 text-blue-400"
                  : "bg-purple-500/20 text-purple-400"
              )}
            >
              {dbMode === "Mock" ? "ğŸ”§ Mock" : "ğŸ”Œ Real"}
            </span>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-sm text-muted-foreground">
              PLC ì—°ê²° ëª¨ë“œ:
            </span>
            <span
              className={cn(
                "px-3 py-1 rounded-full text-xs font-bold",
                plcMode === "Mock"
                  ? "bg-blue-500/20 text-blue-400"
                  : "bg-purple-500/20 text-purple-400"
              )}
            >
              {plcMode === "Mock" ? "ğŸ”§ Mock" : "ğŸ”Œ Real"}
            </span>
          </div>
        </div>
      </section>

      {/* PLC ì œì–´ ì„¹ì…˜ */}
      <section className="mb-12 bg-card border rounded-xl p-6 shadow-sm">
        <h2 className="text-xl font-semibold mb-4">PLC ì œì–´</h2>
        <div className="flex items-center gap-6">
          {/* PLC ìƒíƒœ í‘œì‹œ */}
          <div className="flex items-center gap-3">
            <div
              className={cn(
                "w-4 h-4 rounded-full",
                plcStatus === "RUNNING"
                  ? "bg-green-500"
                  : "bg-red-500 animate-pulse"
              )}
            />
            <span className="text-lg font-medium">
              {plcStatus === "RUNNING" ? "ë¼ì¸ ê°€ë™ ì¤‘" : "ë¼ì¸ ì •ì§€ë¨"}
            </span>
            {plcStopReason && (
              <span className="text-sm text-muted-foreground bg-secondary px-2 py-1 rounded">
                ì‚¬ìœ : {plcStopReason}
              </span>
            )}
          </div>

          {/* PLC ì œì–´ ë²„íŠ¼ */}
          <div className="flex gap-2 ml-auto">
            <button
              onClick={() => togglePlc("force_reset")}
              className="flex items-center gap-2 px-6 py-2 bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 rounded-lg hover:bg-emerald-500/20 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              <Play className="w-4 h-4" /> ê°•ì œ í•´ì œ
            </button>
            <button
              onClick={() => togglePlc("force_stop")}
              className="flex items-center gap-2 px-6 py-2 bg-red-500/10 text-red-500 border border-red-500/20 rounded-lg hover:bg-red-500/20 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              <Square className="w-4 h-4 fill-current" /> ê°•ì œ ì •ì§€
            </button>
          </div>
        </div>
      </section>

      {/* ê·œì¹™ ê´€ë¦¬ ì„¹ì…˜ */}
      <section className="bg-card border rounded-xl p-6 shadow-sm">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-xl font-semibold">ë¶ˆëŸ‰ ëª¨ë‹ˆí„°ë§ ê·œì¹™</h2>
          <button
            onClick={() => setIsModalOpen(true)}
            className="flex items-center gap-2 px-4 py-2 bg-blue-500/10 text-blue-500 border border-blue-500/20 rounded-lg hover:bg-blue-500/20 transition-colors"
          >
            <Plus className="w-4 h-4" /> ê·œì¹™ ì¶”ê°€
          </button>
        </div>

        {/* ê·œì¹™ í…Œì´ë¸” */}
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="border-b border-border/50 text-muted-foreground">
                <th className="p-4">ì½”ë“œ</th>
                <th className="p-4">ë¶ˆëŸ‰ëª…</th>
                <th className="p-4">ì„ê³„ê°’ (ì •ì§€ ê¸°ì¤€)</th>
                <th className="p-4">ìƒíƒœ</th>
                <th className="p-4 text-right">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody>
              {rules.map((rule) => (
                <tr
                  key={rule.code}
                  className="border-b border-border/50 hover:bg-secondary/50"
                >
                  <td className="p-4 font-mono font-bold">{rule.code}</td>
                  <td className="p-4">{rule.name}</td>
                  <td className="p-4">
                    <span
                      className={cn(
                        "px-2 py-1 rounded text-xs font-bold",
                        rule.threshold === 1
                          ? "bg-red-500/20 text-red-500"
                          : "bg-blue-500/20 text-blue-500"
                      )}
                    >
                      {rule.threshold === 1
                        ? "ì¦‰ì‹œ ì •ì§€"
                        : `${rule.threshold}íšŒ / ì‹œê°„`}
                    </span>
                  </td>
                  <td className="p-4">
                    <span className="flex items-center gap-2 text-sm">
                      <div className="w-2 h-2 rounded-full bg-green-500" /> í™œì„±
                    </span>
                  </td>
                  <td className="p-4 text-right flex gap-2 justify-end">
                    <button
                      onClick={() => handleEditRule(rule)}
                      className="p-2 hover:bg-blue-500/20 text-blue-500 rounded transition-colors"
                      title="ê·œì¹™ ìˆ˜ì •"
                    >
                      <Edit className="w-4 h-4" />
                    </button>
                    <button
                      onClick={() => handleDeleteRule(rule.code)}
                      className="p-2 hover:bg-red-500/20 text-red-500 rounded transition-colors"
                      title="ê·œì¹™ ì‚­ì œ"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </td>
                </tr>
              ))}
              {rules.length === 0 && (
                <tr>
                  <td
                    colSpan={5}
                    className="p-8 text-center text-muted-foreground"
                  >
                    ê·œì¹™ì´ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•˜ë ¤ë©´ ê·œì¹™ì„
                    ì¶”ê°€í•˜ì„¸ìš”.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* ê·œì¹™ ì¶”ê°€ ëª¨ë‹¬ */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
          <div className="bg-card border p-8 rounded-xl w-full max-w-md shadow-2xl">
            <h3 className="text-xl font-bold mb-6">ëª¨ë‹ˆí„°ë§ ê·œì¹™ ì¶”ê°€</h3>
            <div className="space-y-4">
              {/* ë¶ˆëŸ‰ ì½”ë“œ ì…ë ¥ */}
              <div>
                <label className="block text-sm font-medium mb-1">
                  ë¶ˆëŸ‰ ì½”ë“œ
                </label>
                <input
                  type="text"
                  value={newRule.code}
                  onChange={(e) =>
                    setNewRule({ ...newRule, code: e.target.value })
                  }
                  className="w-full p-2 rounded border bg-background"
                  placeholder="ì˜ˆ: NG001"
                />
              </div>
              {/* ë¶ˆëŸ‰ ì´ë¦„ ì…ë ¥ */}
              <div>
                <label className="block text-sm font-medium mb-1">ë¶ˆëŸ‰ëª…</label>
                <input
                  type="text"
                  value={newRule.name}
                  onChange={(e) =>
                    setNewRule({ ...newRule, name: e.target.value })
                  }
                  className="w-full p-2 rounded border bg-background"
                  placeholder="ì˜ˆ: í‘œë©´ ìŠ¤í¬ë˜ì¹˜"
                />
              </div>
              {/* ì„ê³„ê°’ ì…ë ¥ */}
              <div>
                <label className="block text-sm font-medium mb-1">
                  ì„ê³„ê°’ (ì •ì§€ ê¸°ì¤€)
                </label>
                <input
                  type="number"
                  value={newRule.threshold}
                  onChange={(e) =>
                    setNewRule({
                      ...newRule,
                      threshold: parseInt(e.target.value),
                    })
                  }
                  className="w-full p-2 rounded border bg-background"
                  min={1}
                />
                <p className="text-xs text-muted-foreground mt-1">
                  ì¦‰ì‹œ ì •ì§€í•˜ë ¤ë©´ 1ë¡œ ì„¤ì •í•˜ì„¸ìš”.
                </p>
              </div>
            </div>
            {/* ëª¨ë‹¬ ë²„íŠ¼ */}
            <div className="flex justify-end gap-2 mt-8">
              <button
                onClick={() => setIsModalOpen(false)}
                className="px-4 py-2 hover:bg-secondary rounded"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={handleAddRule}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                ê·œì¹™ ì €ì¥
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ê·œì¹™ ìˆ˜ì • ëª¨ë‹¬ */}
      {isEditModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
          <div className="bg-card border p-8 rounded-xl w-full max-w-md shadow-2xl">
            <h3 className="text-xl font-bold mb-6">ëª¨ë‹ˆí„°ë§ ê·œì¹™ ìˆ˜ì •</h3>
            <div className="space-y-4">
              {/* ë¶ˆëŸ‰ ì½”ë“œ (ì½ê¸° ì „ìš©) */}
              <div>
                <label className="block text-sm font-medium mb-1">
                  ë¶ˆëŸ‰ ì½”ë“œ
                </label>
                <input
                  type="text"
                  value={editRule.code}
                  disabled
                  className="w-full p-2 rounded border bg-secondary text-muted-foreground cursor-not-allowed"
                />
                <p className="text-xs text-muted-foreground mt-1">
                  ì½”ë“œëŠ” ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                </p>
              </div>
              {/* ë¶ˆëŸ‰ ì´ë¦„ ì…ë ¥ */}
              <div>
                <label className="block text-sm font-medium mb-1">ë¶ˆëŸ‰ëª…</label>
                <input
                  type="text"
                  value={editRule.name}
                  onChange={(e) =>
                    setEditRule({ ...editRule, name: e.target.value })
                  }
                  className="w-full p-2 rounded border bg-background"
                  placeholder="ì˜ˆ: í‘œë©´ ìŠ¤í¬ë˜ì¹˜"
                />
              </div>
              {/* ì„ê³„ê°’ ì…ë ¥ */}
              <div>
                <label className="block text-sm font-medium mb-1">
                  ì„ê³„ê°’ (ì •ì§€ ê¸°ì¤€)
                </label>
                <input
                  type="number"
                  value={editRule.threshold}
                  onChange={(e) =>
                    setEditRule({
                      ...editRule,
                      threshold: parseInt(e.target.value),
                    })
                  }
                  className="w-full p-2 rounded border bg-background"
                  min={1}
                />
                <p className="text-xs text-muted-foreground mt-1">
                  ì¦‰ì‹œ ì •ì§€í•˜ë ¤ë©´ 1ë¡œ ì„¤ì •í•˜ì„¸ìš”.
                </p>
              </div>
            </div>
            {/* ëª¨ë‹¬ ë²„íŠ¼ */}
            <div className="flex justify-end gap-2 mt-8">
              <button
                onClick={() => setIsEditModalOpen(false)}
                className="px-4 py-2 hover:bg-secondary rounded"
              >
                ì·¨ì†Œ
              </button>
              <button
                onClick={handleSaveEdit}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                ìˆ˜ì • ì €ì¥
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ë‹¤ì´ì–¼ë¡œê·¸ ëª¨ë‹¬ */}
      {dialog.isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
          <div className="bg-card border p-6 rounded-xl w-full max-w-md shadow-2xl animate-in fade-in zoom-in duration-200">
            <h3 className="text-lg font-bold mb-4">{dialog.title}</h3>
            <p className="text-muted-foreground mb-6">{dialog.message}</p>
            <div className="flex justify-end gap-2">
              {dialog.type === "confirm" && (
                <button
                  onClick={closeDialog}
                  className="px-4 py-2 hover:bg-secondary rounded transition-colors"
                >
                  ì·¨ì†Œ
                </button>
              )}
              <button
                onClick={() => {
                  if (dialog.type === "confirm" && dialog.onConfirm) {
                    dialog.onConfirm();
                  } else {
                    closeDialog();
                  }
                }}
                className={cn(
                  "px-4 py-2 rounded transition-colors",
                  dialog.type === "confirm"
                    ? "bg-blue-600 text-white hover:bg-blue-700"
                    : "bg-blue-600 text-white hover:bg-blue-700"
                )}
              >
                {dialog.type === "confirm" ? "í™•ì¸" : "ë‹«ê¸°"}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
